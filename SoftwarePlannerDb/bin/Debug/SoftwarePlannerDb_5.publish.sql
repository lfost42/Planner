/*
Deployment script for SoftwarePlannerDb

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "SoftwarePlannerDb"
:setvar DefaultFilePrefix "SoftwarePlannerDb"
:setvar DefaultDataPath "C:\Users\lynda\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"
:setvar DefaultLogPath "C:\Users\lynda\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key c0904eb8-c8dd-4c2e-8cbb-152f38d75764 is skipped, element [dbo].[Notes].[Priority] (SqlSimpleColumn) will not be renamed to PriorityId';


GO
PRINT N'Creating Table [dbo].[Assigned]...';


GO
CREATE TABLE [dbo].[Assigned] (
    [Id]     INT            IDENTITY (1, 1) NOT NULL,
    [UserId] NVARCHAR (450) NOT NULL,
    [TeamId] INT            NOT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[Changes]...';


GO
CREATE TABLE [dbo].[Changes] (
    [Id]            INT           IDENTITY (1, 1) NOT NULL,
    [UpdatedItem]   VARCHAR (50)  NOT NULL,
    [Description]   VARCHAR (250) NOT NULL,
    [PreviousValue] VARCHAR (250) NOT NULL,
    [CurrentValue]  VARCHAR (50)  NOT NULL,
    [DateModified]  DATETIME2 (7) NOT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[Notes]...';


GO
CREATE TABLE [dbo].[Notes] (
    [Id]          INT            IDENTITY (1, 1) NOT NULL,
    [Note]        VARCHAR (500)  NOT NULL,
    [NoteCreated] DATETIME2 (7)  NOT NULL,
    [Creator]     NVARCHAR (450) NOT NULL,
    [PriorityId]  INT            NOT NULL,
    [StatusId]    INT            NOT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[Priority]...';


GO
CREATE TABLE [dbo].[Priority] (
    [Id]       INT          IDENTITY (1, 1) NOT NULL,
    [Priority] VARCHAR (20) NOT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[ProjectNotes]...';


GO
CREATE TABLE [dbo].[ProjectNotes] (
    [Id]         INT IDENTITY (1, 1) NOT NULL,
    [ProjectId]  INT NOT NULL,
    [NoteId]     INT NOT NULL,
    [AssignedId] INT NOT NULL,
    [ChangeId]   INT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[Projects]...';


GO
CREATE TABLE [dbo].[Projects] (
    [Id]                 INT             IDENTITY (1, 1) NOT NULL,
    [ProjectName]        VARCHAR (50)    NULL,
    [ProjectDescription] VARBINARY (500) NOT NULL,
    [TargetDate]         DATETIME2 (7)   NOT NULL,
    [ProjectCreated]     DATETIME2 (7)   NOT NULL,
    [ProjectStatus]      VARCHAR (50)    NOT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[Status]...';


GO
CREATE TABLE [dbo].[Status] (
    [Id]     INT          IDENTITY (1, 1) NOT NULL,
    [Status] VARCHAR (20) NOT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[TaskNotes]...';


GO
CREATE TABLE [dbo].[TaskNotes] (
    [Id]         INT IDENTITY (1, 1) NOT NULL,
    [TaskId]     INT NOT NULL,
    [NoteId]     INT NOT NULL,
    [AssignedId] INT NOT NULL,
    [ChangeId]   INT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[Tasks]...';


GO
CREATE TABLE [dbo].[Tasks] (
    [Id]              INT            IDENTITY (1, 1) NOT NULL,
    [TaskDescription] NVARCHAR (500) NOT NULL,
    [StatusId]        INT            NOT NULL,
    [PriorityId]      INT            NOT NULL,
    [TaskCreated]     DATETIME2 (7)  NOT NULL,
    [TaskClosed]      DATETIME2 (7)  NOT NULL,
    [TaskTargetDate]  DATETIME2 (7)  NOT NULL,
    [CreatorId]       NVARCHAR (450) NOT NULL,
    [ChangeId]        INT            NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[Teams]...';


GO
CREATE TABLE [dbo].[Teams] (
    [Id]       INT          IDENTITY (1, 1) NOT NULL,
    [TeamName] VARCHAR (50) NOT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[TicketNotes]...';


GO
CREATE TABLE [dbo].[TicketNotes] (
    [Id]         INT IDENTITY (1, 1) NOT NULL,
    [TicketId]   INT NOT NULL,
    [NoteId]     INT NOT NULL,
    [AssignedId] INT NOT NULL,
    [ChangeId]   INT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [dbo].[Tickets]...';


GO
CREATE TABLE [dbo].[Tickets] (
    [Id]            INT           IDENTITY (1, 1) NOT NULL,
    [TicketName]    VARCHAR (50)  NOT NULL,
    [StatusClosed]  BIT           NOT NULL,
    [TicketCreated] DATETIME2 (7) NOT NULL,
    [TicketUpdated] DATETIME2 (7) NOT NULL,
    [ChangeId]      INT           NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[Tickets]...';


GO
ALTER TABLE [dbo].[Tickets]
    ADD DEFAULT 0 FOR [StatusClosed];


GO
PRINT N'Creating Foreign Key [dbo].[FK_Assigned_AspNetUsers]...';


GO
ALTER TABLE [dbo].[Assigned] WITH NOCHECK
    ADD CONSTRAINT [FK_Assigned_AspNetUsers] FOREIGN KEY ([UserId]) REFERENCES [dbo].[AspNetUsers] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_Notes_AspNetUsers]...';


GO
ALTER TABLE [dbo].[Notes] WITH NOCHECK
    ADD CONSTRAINT [FK_Notes_AspNetUsers] FOREIGN KEY ([Creator]) REFERENCES [dbo].[AspNetUsers] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_Notes_Priority]...';


GO
ALTER TABLE [dbo].[Notes] WITH NOCHECK
    ADD CONSTRAINT [FK_Notes_Priority] FOREIGN KEY ([PriorityId]) REFERENCES [dbo].[Priority] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_Notes_Status]...';


GO
ALTER TABLE [dbo].[Notes] WITH NOCHECK
    ADD CONSTRAINT [FK_Notes_Status] FOREIGN KEY ([StatusId]) REFERENCES [dbo].[Status] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_ProjectNotes_Projects]...';


GO
ALTER TABLE [dbo].[ProjectNotes] WITH NOCHECK
    ADD CONSTRAINT [FK_ProjectNotes_Projects] FOREIGN KEY ([ProjectId]) REFERENCES [dbo].[Projects] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_ProjectNotes_Notes]...';


GO
ALTER TABLE [dbo].[ProjectNotes] WITH NOCHECK
    ADD CONSTRAINT [FK_ProjectNotes_Notes] FOREIGN KEY ([NoteId]) REFERENCES [dbo].[Notes] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_ProjectNotes_Assigned]...';


GO
ALTER TABLE [dbo].[ProjectNotes] WITH NOCHECK
    ADD CONSTRAINT [FK_ProjectNotes_Assigned] FOREIGN KEY ([AssignedId]) REFERENCES [dbo].[Assigned] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_ProjectNotes_Changes]...';


GO
ALTER TABLE [dbo].[ProjectNotes] WITH NOCHECK
    ADD CONSTRAINT [FK_ProjectNotes_Changes] FOREIGN KEY ([ChangeId]) REFERENCES [dbo].[Changes] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_TaskNotes_Tickets]...';


GO
ALTER TABLE [dbo].[TaskNotes] WITH NOCHECK
    ADD CONSTRAINT [FK_TaskNotes_Tickets] FOREIGN KEY ([TaskId]) REFERENCES [dbo].[Tasks] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_TaskNotes_Notes]...';


GO
ALTER TABLE [dbo].[TaskNotes] WITH NOCHECK
    ADD CONSTRAINT [FK_TaskNotes_Notes] FOREIGN KEY ([NoteId]) REFERENCES [dbo].[Notes] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_TaskNotes_Assigned]...';


GO
ALTER TABLE [dbo].[TaskNotes] WITH NOCHECK
    ADD CONSTRAINT [FK_TaskNotes_Assigned] FOREIGN KEY ([AssignedId]) REFERENCES [dbo].[Assigned] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_TaskNotes_Changes]...';


GO
ALTER TABLE [dbo].[TaskNotes] WITH NOCHECK
    ADD CONSTRAINT [FK_TaskNotes_Changes] FOREIGN KEY ([ChangeId]) REFERENCES [dbo].[Changes] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_Tasks_Creator]...';


GO
ALTER TABLE [dbo].[Tasks] WITH NOCHECK
    ADD CONSTRAINT [FK_Tasks_Creator] FOREIGN KEY ([CreatorId]) REFERENCES [dbo].[AspNetUsers] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_Tasks_Priority]...';


GO
ALTER TABLE [dbo].[Tasks] WITH NOCHECK
    ADD CONSTRAINT [FK_Tasks_Priority] FOREIGN KEY ([PriorityId]) REFERENCES [dbo].[Priority] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_Tasks_Status]...';


GO
ALTER TABLE [dbo].[Tasks] WITH NOCHECK
    ADD CONSTRAINT [FK_Tasks_Status] FOREIGN KEY ([StatusId]) REFERENCES [dbo].[Status] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_Tasks_Changes]...';


GO
ALTER TABLE [dbo].[Tasks] WITH NOCHECK
    ADD CONSTRAINT [FK_Tasks_Changes] FOREIGN KEY ([ChangeId]) REFERENCES [dbo].[Changes] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_TicketNotes_Tickets]...';


GO
ALTER TABLE [dbo].[TicketNotes] WITH NOCHECK
    ADD CONSTRAINT [FK_TicketNotes_Tickets] FOREIGN KEY ([TicketId]) REFERENCES [dbo].[Tickets] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_TicketNotes_Notes]...';


GO
ALTER TABLE [dbo].[TicketNotes] WITH NOCHECK
    ADD CONSTRAINT [FK_TicketNotes_Notes] FOREIGN KEY ([NoteId]) REFERENCES [dbo].[Notes] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_TicketNotes_Assigned]...';


GO
ALTER TABLE [dbo].[TicketNotes] WITH NOCHECK
    ADD CONSTRAINT [FK_TicketNotes_Assigned] FOREIGN KEY ([AssignedId]) REFERENCES [dbo].[Assigned] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_TicketNotes_Changes]...';


GO
ALTER TABLE [dbo].[TicketNotes] WITH NOCHECK
    ADD CONSTRAINT [FK_TicketNotes_Changes] FOREIGN KEY ([ChangeId]) REFERENCES [dbo].[Changes] ([Id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_Tickets_Changes]...';


GO
ALTER TABLE [dbo].[Tickets] WITH NOCHECK
    ADD CONSTRAINT [FK_Tickets_Changes] FOREIGN KEY ([ChangeId]) REFERENCES [dbo].[Changes] ([Id]);


GO
-- Refactoring step to update target server with deployed transaction logs
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'c0904eb8-c8dd-4c2e-8cbb-152f38d75764')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('c0904eb8-c8dd-4c2e-8cbb-152f38d75764')

GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Assigned] WITH CHECK CHECK CONSTRAINT [FK_Assigned_AspNetUsers];

ALTER TABLE [dbo].[Notes] WITH CHECK CHECK CONSTRAINT [FK_Notes_AspNetUsers];

ALTER TABLE [dbo].[Notes] WITH CHECK CHECK CONSTRAINT [FK_Notes_Priority];

ALTER TABLE [dbo].[Notes] WITH CHECK CHECK CONSTRAINT [FK_Notes_Status];

ALTER TABLE [dbo].[ProjectNotes] WITH CHECK CHECK CONSTRAINT [FK_ProjectNotes_Projects];

ALTER TABLE [dbo].[ProjectNotes] WITH CHECK CHECK CONSTRAINT [FK_ProjectNotes_Notes];

ALTER TABLE [dbo].[ProjectNotes] WITH CHECK CHECK CONSTRAINT [FK_ProjectNotes_Assigned];

ALTER TABLE [dbo].[ProjectNotes] WITH CHECK CHECK CONSTRAINT [FK_ProjectNotes_Changes];

ALTER TABLE [dbo].[TaskNotes] WITH CHECK CHECK CONSTRAINT [FK_TaskNotes_Tickets];

ALTER TABLE [dbo].[TaskNotes] WITH CHECK CHECK CONSTRAINT [FK_TaskNotes_Notes];

ALTER TABLE [dbo].[TaskNotes] WITH CHECK CHECK CONSTRAINT [FK_TaskNotes_Assigned];

ALTER TABLE [dbo].[TaskNotes] WITH CHECK CHECK CONSTRAINT [FK_TaskNotes_Changes];

ALTER TABLE [dbo].[Tasks] WITH CHECK CHECK CONSTRAINT [FK_Tasks_Creator];

ALTER TABLE [dbo].[Tasks] WITH CHECK CHECK CONSTRAINT [FK_Tasks_Priority];

ALTER TABLE [dbo].[Tasks] WITH CHECK CHECK CONSTRAINT [FK_Tasks_Status];

ALTER TABLE [dbo].[Tasks] WITH CHECK CHECK CONSTRAINT [FK_Tasks_Changes];

ALTER TABLE [dbo].[TicketNotes] WITH CHECK CHECK CONSTRAINT [FK_TicketNotes_Tickets];

ALTER TABLE [dbo].[TicketNotes] WITH CHECK CHECK CONSTRAINT [FK_TicketNotes_Notes];

ALTER TABLE [dbo].[TicketNotes] WITH CHECK CHECK CONSTRAINT [FK_TicketNotes_Assigned];

ALTER TABLE [dbo].[TicketNotes] WITH CHECK CHECK CONSTRAINT [FK_TicketNotes_Changes];

ALTER TABLE [dbo].[Tickets] WITH CHECK CHECK CONSTRAINT [FK_Tickets_Changes];


GO
PRINT N'Update complete.';


GO
